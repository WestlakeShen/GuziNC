---
title: "Figure 2"
author: "Yayu Wang and Canzhi Jin"
date: "2021/11/4"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
 
### Constructed linear Mixed  Models for six key traits###

#### Linear mixed models for the trait TSLW with thirty rounds of five-fold cross-validation ###

con <- file("TSLW.log") 
sink(con, append=TRUE)
sink(con, append=TRUE, type="message")

data1<-read.csv("OTU0.7.csv")
data2<-read.csv("TSLWSNP.csv")
df.TSLW<-cbind(data1[,c(1,1008,2:1005,1015:1024)],data2[,-1])
data.TSLW<-data.frame(na.omit(df.TSLW))

options(scipen=200)
result<-c()
for (i in 3:1006){
        fit<-lm(TSLW~data.TSLW[,i],data=data.TSLW)
        result<-rbind(result,c(colnames(data.TSLW)[i],coef(summary(fit))[2,c(1,2,4)]))
}
colnames(result)[4] <- 'P'
r<-data.frame(result)
X<-r[order(r[,4]),]
X1<-r[1:200,]
#write.csv(X1,file="TSLWOTU.csv")
for (j in X1[1]){paste(j,collapse = "+")}->cc

for (s in 1:30){

#split
set.seed(s)
sub1<-sample(1:nrow(data.TSLW),round(nrow(data.TSLW)*1/5))
data_traint1<-data.TSLW[-sub1,]

sub2<-sample(1:nrow(data_traint1),round(nrow(data_traint1)*1/4))
data_traint2<-data_traint1[-sub2,]

sub3<-sample(1:nrow(data_traint2),round(nrow(data_traint2)*1/3))
data_traint3<-data_traint2[-sub3,]

sub4<-sample(1:nrow(data_traint3),round(nrow(data_traint3)*1/2))
data_traint4<-data_traint3[-sub4,]

sub5<-sample(1:nrow(data_traint4),round(nrow(data_traint4)*1))

data_test1<-data.TSLW[sub1,]
data_test2<-data_traint1[sub2,]
data_test3<-data_traint2[sub3,]
data_test4<-data_traint3[-sub4,]
data_test5<-data_traint3[sub4,]
data_train1<-rbind(data_test2,data_test3,data_test4,data_test5)
data_train2<-rbind(data_test1,data_test3,data_test4,data_test5)
data_train3<-rbind(data_test1,data_test2,data_test4,data_test5)
data_train4<-rbind(data_test1,data_test2,data_test3,data_test5)
data_train5<-rbind(data_test1,data_test2,data_test3,data_test4)

#m1
print(paste("seed:",s,"model1"))
TSLWm1 <- lm(paste0("TSLW~", paste(grep("^snp", colnames(data_train1), value = T), collapse = "+")), data = data_train1)
print(summary(TSLWm1))
TSLWm <- step(TSLWm1, direction = "backward")
TSLWm2 <- update(TSLWm, paste(". ~ . +", cc))

tryCatch({
TSLWm <- step(TSLWm2, direction = "backward")
name.snp <- grep("snp", names(TSLWm$coefficients), value = T)
name.otu <- grep("OTU", names(TSLWm$coefficients), value = T)
TSLWm3 <- update(TSLWm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
TSLWm <- step(TSLWm3, direction = "backward")
print(summary(TSLWm))
TSLWm4<-update(TSLWm, paste(". ~ . +", paste(grep("^PC", colnames(data_train1), value = T), collapse = "+")))
TSLWm <- step(TSLWm4, direction = "backward")
print(summary(TSLWm))

sry<-summary(TSLWm)
seed<-paste("seed:",s,"model1")
MSPE<-mean((data_test1$TSLW - predict.lm(TSLWm, data_test1)) ^ 2)
z<-cor.test(data_test1$TSLW,predict.lm(TSLWm, data_test1),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(TSLWm)$fstatistic[1]
d1<-summary(TSLWm)$fstatistic[2]
d2<-summary(TSLWm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model1 fail"))
seed<-paste("seed:",s,"model1")
MSPE<-0
Rsquare<-0
PearsonP<-0
PearsonE<-0
Pvalue<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})

#m2
print(paste("seed:",s,"model2"))
TSLWm1 <- lm(paste0("TSLW~", paste(grep("^snp", colnames(data_train2), value = T), collapse = "+")), data = data_train2)
print(summary(TSLWm1))
TSLWm <- step(TSLWm1, direction = "backward")
TSLWm2 <- update(TSLWm, paste(". ~ . +", cc))

tryCatch({
TSLWm <- step(TSLWm2, direction = "backward")
name.snp <- grep("snp", names(TSLWm$coefficients), value = T)
name.otu <- grep("OTU", names(TSLWm$coefficients), value = T)
TSLWm3 <- update(TSLWm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
TSLWm <- step(TSLWm3, direction = "backward")
print(summary(TSLWm))
TSLWm4<-update(TSLWm, paste(". ~ . +", paste(grep("^PC", colnames(data_train2), value = T), collapse = "+")))
TSLWm <- step(TSLWm4, direction = "backward")
print(summary(TSLWm))

sry<-summary(TSLWm)
seed<-paste("seed:",s,"model2")
MSPE<-mean((data_test2$TSLW - predict.lm(TSLWm, data_test2)) ^ 2)
z<-cor.test(data_test2$TSLW,predict.lm(TSLWm, data_test2),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(TSLWm)$fstatistic[1]
d1<-summary(TSLWm)$fstatistic[2]
d2<-summary(TSLWm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model2 fail"))
seed<-paste("seed:",s,"model2")
MSPE<-0
Rsquare<-0
Pvalue<-0
PearsonP<-0
PearsonE<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})

#m3
print(paste("seed:",s,"model3"))
TSLWm1 <- lm(paste0("TSLW~", paste(grep("^snp", colnames(data_train3), value = T), collapse = "+")), data = data_train3)
print(summary(TSLWm1))
TSLWm <- step(TSLWm1, direction = "backward")
TSLWm2 <- update(TSLWm, paste(". ~ . +", cc))

tryCatch({
TSLWm <- step(TSLWm2, direction = "backward")
name.snp <- grep("snp", names(TSLWm$coefficients), value = T)
name.otu <- grep("OTU", names(TSLWm$coefficients), value = T)
TSLWm3 <- update(TSLWm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
TSLWm <- step(TSLWm3, direction = "backward")
print(summary(TSLWm))
TSLWm4<-update(TSLWm, paste(". ~ . +", paste(grep("^PC", colnames(data_train3), value = T), collapse = "+")))
TSLWm <- step(TSLWm4, direction = "backward")
print(summary(TSLWm))

sry<-summary(TSLWm)
seed<-paste("seed:",s,"model3")
MSPE<-mean((data_test3$TSLW - predict.lm(TSLWm, data_test3)) ^ 2)
z<-cor.test(data_test3$TSLW,predict.lm(TSLWm, data_test3),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(TSLWm)$fstatistic[1]
d1<-summary(TSLWm)$fstatistic[2]
d2<-summary(TSLWm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model3 fail"))
seed<-paste("seed:",s,"model3")
MSPE<-0
Rsquare<-0
Pvalue<-0
PearsonP<-0
PearsonE<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})

#m4
print(paste("seed:",s,"model4"))
TSLWm1 <- lm(paste0("TSLW~", paste(grep("^snp", colnames(data_train4), value = T), collapse = "+")), data = data_train4)
print(summary(TSLWm1))
TSLWm <- step(TSLWm1, direction = "backward")
TSLWm2 <- update(TSLWm, paste(". ~ . +", cc))

tryCatch({
TSLWm <- step(TSLWm2, direction = "backward")
name.snp <- grep("snp", names(TSLWm$coefficients), value = T)
name.otu <- grep("OTU", names(TSLWm$coefficients), value = T)
TSLWm3 <- update(TSLWm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
TSLWm <- step(TSLWm3, direction = "backward")
print(summary(TSLWm))
TSLWm4<-update(TSLWm, paste(". ~ . +", paste(grep("^PC", colnames(data_train4), value = T), collapse = "+")))
TSLWm <- step(TSLWm4, direction = "backward")
print(summary(TSLWm))

sry<-summary(TSLWm)
seed<-paste("seed:",s,"model4")
MSPE<-mean((data_test4$TSLW - predict.lm(TSLWm, data_test4)) ^ 2)
z<-cor.test(data_test4$TSLW,predict.lm(TSLWm, data_test4),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(TSLWm)$fstatistic[1]
d1<-summary(TSLWm)$fstatistic[2]
d2<-summary(TSLWm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model4 fail"))
seed<-paste("seed:",s,"model4")
MSPE<-0
Rsquare<-0
Pvalue<-0
PearsonP<-0
PearsonE<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})

#m5
print(paste("seed:",s,"model5"))
TSLWm1 <- lm(paste0("TSLW~", paste(grep("^snp", colnames(data_train5), value = T), collapse = "+")), data = data_train5)
print(summary(TSLWm1))
TSLWm <- step(TSLWm1, direction = "backward")
TSLWm2 <- update(TSLWm, paste(". ~ . +", cc))

tryCatch({
TSLWm <- step(TSLWm2, direction = "backward")
name.snp <- grep("snp", names(TSLWm$coefficients), value = T)
name.otu <- grep("OTU", names(TSLWm$coefficients), value = T)
TSLWm3 <- update(TSLWm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
TSLWm <- step(TSLWm3, direction = "backward")
print(summary(TSLWm))
TSLWm4<-update(TSLWm, paste(". ~ . +", paste(grep("^PC", colnames(data_train5), value = T), collapse = "+")))
TSLWm <- step(TSLWm4, direction = "backward")
print(summary(TSLWm))

sry<-summary(TSLWm)
seed<-paste("seed:",s,"model5")
MSPE<-mean((data_test5$TSLW - predict.lm(TSLWm, data_test5)) ^ 2)
z<-cor.test(data_test5$TSLW,predict.lm(TSLWm, data_test5),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(TSLWm)$fstatistic[1]
d1<-summary(TSLWm)$fstatistic[2]
d2<-summary(TSLWm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model5 fail"))
seed<-paste("seed:",s,"model5")
MSPE<-0
Rsquare<-0
Pvalue<-0
PearsonP<-0
PearsonE<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})
}

#### Linear mixed models for the trait MSW with thirty rounds of five-fold cross-validation ###

con <- file("MSW.log") 
sink(con, append=TRUE)
sink(con, append=TRUE, type="message")

data1<-read.csv("OTU0.7.csv")
data2<-read.csv("MSWSNP.csv")
df.MSW<-cbind(data1[,c(1,1009,2:1005,1015:1024)],data2[,-1])
data.MSW<-data.frame(na.omit(df.MSW))

options(scipen=200)
result<-c()
for (i in 3:1006){
        fit<-lm(MSW~data.MSW[,i],data=data.MSW)
        result<-rbind(result,c(colnames(data.MSW)[i],coef(summary(fit))[2,c(1,2,4)]))
}
colnames(result)[4] <- 'P'
r<-data.frame(result)
X<-r[order(r[,4]),]
X1<-r[1:200,]
#write.csv(X1,file="MSWOTU.csv")
for (j in X1[1]){paste(j,collapse = "+")}->cc

for (s in 1:30){

#split
set.seed(s)
sub1<-sample(1:nrow(data.MSW),round(nrow(data.MSW)*1/5))
data_traint1<-data.MSW[-sub1,]

sub2<-sample(1:nrow(data_traint1),round(nrow(data_traint1)*1/4))
data_traint2<-data_traint1[-sub2,]

sub3<-sample(1:nrow(data_traint2),round(nrow(data_traint2)*1/3))
data_traint3<-data_traint2[-sub3,]

sub4<-sample(1:nrow(data_traint3),round(nrow(data_traint3)*1/2))
data_traint4<-data_traint3[-sub4,]

sub5<-sample(1:nrow(data_traint4),round(nrow(data_traint4)*1))

data_test1<-data.MSW[sub1,]
data_test2<-data_traint1[sub2,]
data_test3<-data_traint2[sub3,]
data_test4<-data_traint3[-sub4,]
data_test5<-data_traint3[sub4,]
data_train1<-rbind(data_test2,data_test3,data_test4,data_test5)
data_train2<-rbind(data_test1,data_test3,data_test4,data_test5)
data_train3<-rbind(data_test1,data_test2,data_test4,data_test5)
data_train4<-rbind(data_test1,data_test2,data_test3,data_test5)
data_train5<-rbind(data_test1,data_test2,data_test3,data_test4)

#m1
print(paste("seed:",s,"model1"))
MSWm1 <- lm(paste0("MSW~", paste(grep("^snp", colnames(data_train1), value = T), collapse = "+")), data = data_train1)
print(summary(MSWm1))
MSWm <- step(MSWm1, direction = "backward")
MSWm2 <- update(MSWm, paste(". ~ . +", cc))

tryCatch({
MSWm <- step(MSWm2, direction = "backward")
name.snp <- grep("snp", names(MSWm$coefficients), value = T)
name.otu <- grep("OTU", names(MSWm$coefficients), value = T)
MSWm3 <- update(MSWm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
MSWm <- step(MSWm3, direction = "backward")
print(summary(MSWm))
MSWm4<-update(MSWm, paste(". ~ . +", paste(grep("^PC", colnames(data_train1), value = T), collapse = "+")))
MSWm <- step(MSWm4, direction = "backward")
print(summary(MSWm))

sry<-summary(MSWm)
seed<-paste("seed:",s,"model1")
MSPE<-mean((data_test1$MSW - predict.lm(MSWm, data_test1)) ^ 2)
z<-cor.test(data_test1$MSW,predict.lm(MSWm, data_test1),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(MSWm)$fstatistic[1]
d1<-summary(MSWm)$fstatistic[2]
d2<-summary(MSWm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model1 fail"))
seed<-paste("seed:",s,"model1")
MSPE<-0
Rsquare<-0
PearsonP<-0
PearsonE<-0
Pvalue<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})

#m2
print(paste("seed:",s,"model2"))
MSWm1 <- lm(paste0("MSW~", paste(grep("^snp", colnames(data_train2), value = T), collapse = "+")), data = data_train2)
print(summary(MSWm1))
MSWm <- step(MSWm1, direction = "backward")
MSWm2 <- update(MSWm, paste(". ~ . +", cc))

tryCatch({
MSWm <- step(MSWm2, direction = "backward")
name.snp <- grep("snp", names(MSWm$coefficients), value = T)
name.otu <- grep("OTU", names(MSWm$coefficients), value = T)
MSWm3 <- update(MSWm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
MSWm <- step(MSWm3, direction = "backward")
print(summary(MSWm))
MSWm4<-update(MSWm, paste(". ~ . +", paste(grep("^PC", colnames(data_train2), value = T), collapse = "+")))
MSWm <- step(MSWm4, direction = "backward")
print(summary(MSWm))

sry<-summary(MSWm)
seed<-paste("seed:",s,"model2")
MSPE<-mean((data_test2$MSW - predict.lm(MSWm, data_test2)) ^ 2)
z<-cor.test(data_test2$MSW,predict.lm(MSWm, data_test2),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(MSWm)$fstatistic[1]
d1<-summary(MSWm)$fstatistic[2]
d2<-summary(MSWm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model2 fail"))
seed<-paste("seed:",s,"model2")
MSPE<-0
Rsquare<-0
Pvalue<-0
PearsonP<-0
PearsonE<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})

#m3
print(paste("seed:",s,"model3"))
MSWm1 <- lm(paste0("MSW~", paste(grep("^snp", colnames(data_train3), value = T), collapse = "+")), data = data_train3)
print(summary(MSWm1))
MSWm <- step(MSWm1, direction = "backward")
MSWm2 <- update(MSWm, paste(". ~ . +", cc))

tryCatch({
MSWm <- step(MSWm2, direction = "backward")
name.snp <- grep("snp", names(MSWm$coefficients), value = T)
name.otu <- grep("OTU", names(MSWm$coefficients), value = T)
MSWm3 <- update(MSWm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
MSWm <- step(MSWm3, direction = "backward")
print(summary(MSWm))
MSWm4<-update(MSWm, paste(". ~ . +", paste(grep("^PC", colnames(data_train3), value = T), collapse = "+")))
MSWm <- step(MSWm4, direction = "backward")
print(summary(MSWm))

sry<-summary(MSWm)
seed<-paste("seed:",s,"model3")
MSPE<-mean((data_test3$MSW - predict.lm(MSWm, data_test3)) ^ 2)
z<-cor.test(data_test3$MSW,predict.lm(MSWm, data_test3),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(MSWm)$fstatistic[1]
d1<-summary(MSWm)$fstatistic[2]
d2<-summary(MSWm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model3 fail"))
seed<-paste("seed:",s,"model3")
MSPE<-0
Rsquare<-0
Pvalue<-0
PearsonP<-0
PearsonE<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})

#m4
print(paste("seed:",s,"model4"))
MSWm1 <- lm(paste0("MSW~", paste(grep("^snp", colnames(data_train4), value = T), collapse = "+")), data = data_train4)
print(summary(MSWm1))
MSWm <- step(MSWm1, direction = "backward")
MSWm2 <- update(MSWm, paste(". ~ . +", cc))

tryCatch({
MSWm <- step(MSWm2, direction = "backward")
name.snp <- grep("snp", names(MSWm$coefficients), value = T)
name.otu <- grep("OTU", names(MSWm$coefficients), value = T)
MSWm3 <- update(MSWm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
MSWm <- step(MSWm3, direction = "backward")
print(summary(MSWm))
MSWm4<-update(MSWm, paste(". ~ . +", paste(grep("^PC", colnames(data_train4), value = T), collapse = "+")))
MSWm <- step(MSWm4, direction = "backward")
print(summary(MSWm))

sry<-summary(MSWm)
seed<-paste("seed:",s,"model4")
MSPE<-mean((data_test4$MSW - predict.lm(MSWm, data_test4)) ^ 2)
z<-cor.test(data_test4$MSW,predict.lm(MSWm, data_test4),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(MSWm)$fstatistic[1]
d1<-summary(MSWm)$fstatistic[2]
d2<-summary(MSWm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model4 fail"))
seed<-paste("seed:",s,"model4")
MSPE<-0
Rsquare<-0
Pvalue<-0
PearsonP<-0
PearsonE<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})

#m5
print(paste("seed:",s,"model5"))
MSWm1 <- lm(paste0("MSW~", paste(grep("^snp", colnames(data_train5), value = T), collapse = "+")), data = data_train5)
print(summary(MSWm1))
MSWm <- step(MSWm1, direction = "backward")
MSWm2 <- update(MSWm, paste(". ~ . +", cc))

tryCatch({
MSWm <- step(MSWm2, direction = "backward")
name.snp <- grep("snp", names(MSWm$coefficients), value = T)
name.otu <- grep("OTU", names(MSWm$coefficients), value = T)
MSWm3 <- update(MSWm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
MSWm <- step(MSWm3, direction = "backward")
print(summary(MSWm))
MSWm4<-update(MSWm, paste(". ~ . +", paste(grep("^PC", colnames(data_train5), value = T), collapse = "+")))
MSWm <- step(MSWm4, direction = "backward")
print(summary(MSWm))

sry<-summary(MSWm)
seed<-paste("seed:",s,"model5")
MSPE<-mean((data_test5$MSW - predict.lm(MSWm, data_test5)) ^ 2)
z<-cor.test(data_test5$MSW,predict.lm(MSWm, data_test5),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(MSWm)$fstatistic[1]
d1<-summary(MSWm)$fstatistic[2]
d2<-summary(MSWm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model5 fail"))
seed<-paste("seed:",s,"model5")
MSPE<-0
Rsquare<-0
Pvalue<-0
PearsonP<-0
PearsonE<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})
}


#### Linear mixed models for the trait MSPD with thirty rounds of five-fold cross-validation ###

con <- file("MSPD.log") 
sink(con, append=TRUE)
sink(con, append=TRUE, type="message")

data1<-read.csv("OTU0.7.csv")
data2<-read.csv("MSPDSNP.csv")
df.MSPD<-cbind(data1[,c(1,1010,2:1005,1015:1024)],data2[,-1])
data.MSPD<-data.frame(na.omit(df.MSPD))

options(scipen=200)
result<-c()
for (i in 3:1006){
        fit<-lm(MSPD~data.MSPD[,i],data=data.MSPD)
        result<-rbind(result,c(colnames(data.MSPD)[i],coef(summary(fit))[2,c(1,2,4)]))
}
colnames(result)[4] <- 'P'
r<-data.frame(result)
X<-r[order(r[,4]),]
X1<-r[1:200,]
write.csv(X1,file="MSPDOTU.csv")
for (j in X1[1]){paste(j,collapse = "+")}->cc

for (s in 1:30){

#split
set.seed(s)
sub1<-sample(1:nrow(data.MSPD),round(nrow(data.MSPD)*1/5))
data_traint1<-data.MSPD[-sub1,]

sub2<-sample(1:nrow(data_traint1),round(nrow(data_traint1)*1/4))
data_traint2<-data_traint1[-sub2,]

sub3<-sample(1:nrow(data_traint2),round(nrow(data_traint2)*1/3))
data_traint3<-data_traint2[-sub3,]

sub4<-sample(1:nrow(data_traint3),round(nrow(data_traint3)*1/2))
data_traint4<-data_traint3[-sub4,]

sub5<-sample(1:nrow(data_traint4),round(nrow(data_traint4)*1))

data_test1<-data.MSPD[sub1,]
data_test2<-data_traint1[sub2,]
data_test3<-data_traint2[sub3,]
data_test4<-data_traint3[-sub4,]
data_test5<-data_traint3[sub4,]
data_train1<-rbind(data_test2,data_test3,data_test4,data_test5)
data_train2<-rbind(data_test1,data_test3,data_test4,data_test5)
data_train3<-rbind(data_test1,data_test2,data_test4,data_test5)
data_train4<-rbind(data_test1,data_test2,data_test3,data_test5)
data_train5<-rbind(data_test1,data_test2,data_test3,data_test4)

#m1
print(paste("seed:",s,"model1"))
MSPDm1 <- lm(paste0("MSPD~", paste(grep("^snp", colnames(data_train1), value = T), collapse = "+")), data = data_train1)
print(summary(MSPDm1))
MSPDm <- step(MSPDm1, direction = "backward")
MSPDm2 <- update(MSPDm, paste(". ~ . +", cc))

tryCatch({
MSPDm <- step(MSPDm2, direction = "backward")
name.snp <- grep("snp", names(MSPDm$coefficients), value = T)
name.otu <- grep("OTU", names(MSPDm$coefficients), value = T)
MSPDm3 <- update(MSPDm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
MSPDm <- step(MSPDm3, direction = "backward")
print(summary(MSPDm))
MSPDm4<-update(MSPDm, paste(". ~ . +", paste(grep("^PC", colnames(data_train1), value = T), collapse = "+")))
MSPDm <- step(MSPDm4, direction = "backward")
print(summary(MSPDm))

sry<-summary(MSPDm)
seed<-paste("seed:",s,"model1")
MSPE<-mean((data_test1$MSPD - predict.lm(MSPDm, data_test1)) ^ 2)
z<-cor.test(data_test1$MSPD,predict.lm(MSPDm, data_test1),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(MSPDm)$fstatistic[1]
d1<-summary(MSPDm)$fstatistic[2]
d2<-summary(MSPDm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model1 fail"))
seed<-paste("seed:",s,"model1")
MSPE<-0
Rsquare<-0
PearsonP<-0
PearsonE<-0
Pvalue<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})

#m2
print(paste("seed:",s,"model2"))
MSPDm1 <- lm(paste0("MSPD~", paste(grep("^snp", colnames(data_train2), value = T), collapse = "+")), data = data_train2)
print(summary(MSPDm1))
MSPDm <- step(MSPDm1, direction = "backward")
MSPDm2 <- update(MSPDm, paste(". ~ . +", cc))

tryCatch({
MSPDm <- step(MSPDm2, direction = "backward")
name.snp <- grep("snp", names(MSPDm$coefficients), value = T)
name.otu <- grep("OTU", names(MSPDm$coefficients), value = T)
MSPDm3 <- update(MSPDm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
MSPDm <- step(MSPDm3, direction = "backward")
print(summary(MSPDm))
MSPDm4<-update(MSPDm, paste(". ~ . +", paste(grep("^PC", colnames(data_train2), value = T), collapse = "+")))
MSPDm <- step(MSPDm4, direction = "backward")
print(summary(MSPDm))

sry<-summary(MSPDm)
seed<-paste("seed:",s,"model2")
MSPE<-mean((data_test2$MSPD - predict.lm(MSPDm, data_test2)) ^ 2)
z<-cor.test(data_test2$MSPD,predict.lm(MSPDm, data_test2),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(MSPDm)$fstatistic[1]
d1<-summary(MSPDm)$fstatistic[2]
d2<-summary(MSPDm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model2 fail"))
seed<-paste("seed:",s,"model2")
MSPE<-0
Rsquare<-0
Pvalue<-0
PearsonP<-0
PearsonE<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})

#m3
print(paste("seed:",s,"model3"))
MSPDm1 <- lm(paste0("MSPD~", paste(grep("^snp", colnames(data_train3), value = T), collapse = "+")), data = data_train3)
print(summary(MSPDm1))
MSPDm <- step(MSPDm1, direction = "backward")
MSPDm2 <- update(MSPDm, paste(". ~ . +", cc))

tryCatch({
MSPDm <- step(MSPDm2, direction = "backward")
name.snp <- grep("snp", names(MSPDm$coefficients), value = T)
name.otu <- grep("OTU", names(MSPDm$coefficients), value = T)
MSPDm3 <- update(MSPDm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
MSPDm <- step(MSPDm3, direction = "backward")
print(summary(MSPDm))
MSPDm4<-update(MSPDm, paste(". ~ . +", paste(grep("^PC", colnames(data_train3), value = T), collapse = "+")))
MSPDm <- step(MSPDm4, direction = "backward")
print(summary(MSPDm))

sry<-summary(MSPDm)
seed<-paste("seed:",s,"model3")
MSPE<-mean((data_test3$MSPD - predict.lm(MSPDm, data_test3)) ^ 2)
z<-cor.test(data_test3$MSPD,predict.lm(MSPDm, data_test3),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(MSPDm)$fstatistic[1]
d1<-summary(MSPDm)$fstatistic[2]
d2<-summary(MSPDm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model3 fail"))
seed<-paste("seed:",s,"model3")
MSPE<-0
Rsquare<-0
Pvalue<-0
PearsonP<-0
PearsonE<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})

#m4
print(paste("seed:",s,"model4"))
MSPDm1 <- lm(paste0("MSPD~", paste(grep("^snp", colnames(data_train4), value = T), collapse = "+")), data = data_train4)
print(summary(MSPDm1))
MSPDm <- step(MSPDm1, direction = "backward")
MSPDm2 <- update(MSPDm, paste(". ~ . +", cc))

tryCatch({
MSPDm <- step(MSPDm2, direction = "backward")
name.snp <- grep("snp", names(MSPDm$coefficients), value = T)
name.otu <- grep("OTU", names(MSPDm$coefficients), value = T)
MSPDm3 <- update(MSPDm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
MSPDm <- step(MSPDm3, direction = "backward")
print(summary(MSPDm))
MSPDm4<-update(MSPDm, paste(". ~ . +", paste(grep("^PC", colnames(data_train4), value = T), collapse = "+")))
MSPDm <- step(MSPDm4, direction = "backward")
print(summary(MSPDm))

sry<-summary(MSPDm)
seed<-paste("seed:",s,"model4")
MSPE<-mean((data_test4$MSPD - predict.lm(MSPDm, data_test4)) ^ 2)
z<-cor.test(data_test4$MSPD,predict.lm(MSPDm, data_test4),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(MSPDm)$fstatistic[1]
d1<-summary(MSPDm)$fstatistic[2]
d2<-summary(MSPDm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model4 fail"))
seed<-paste("seed:",s,"model4")
MSPE<-0
Rsquare<-0
Pvalue<-0
PearsonP<-0
PearsonE<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})

#m5
print(paste("seed:",s,"model5"))
MSPDm1 <- lm(paste0("MSPD~", paste(grep("^snp", colnames(data_train5), value = T), collapse = "+")), data = data_train5)
print(summary(MSPDm1))
MSPDm <- step(MSPDm1, direction = "backward")
MSPDm2 <- update(MSPDm, paste(". ~ . +", cc))

tryCatch({
MSPDm <- step(MSPDm2, direction = "backward")
name.snp <- grep("snp", names(MSPDm$coefficients), value = T)
name.otu <- grep("OTU", names(MSPDm$coefficients), value = T)
MSPDm3 <- update(MSPDm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
MSPDm <- step(MSPDm3, direction = "backward")
print(summary(MSPDm))
MSPDm4<-update(MSPDm, paste(". ~ . +", paste(grep("^PC", colnames(data_train5), value = T), collapse = "+")))
MSPDm <- step(MSPDm4, direction = "backward")
print(summary(MSPDm))

sry<-summary(MSPDm)
seed<-paste("seed:",s,"model5")
MSPE<-mean((data_test5$MSPD - predict.lm(MSPDm, data_test5)) ^ 2)
z<-cor.test(data_test5$MSPD,predict.lm(MSPDm, data_test5),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(MSPDm)$fstatistic[1]
d1<-summary(MSPDm)$fstatistic[2]
d2<-summary(MSPDm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model5 fail"))
seed<-paste("seed:",s,"model5")
MSPE<-0
Rsquare<-0
Pvalue<-0
PearsonP<-0
PearsonE<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})
}

#### Linear mixed models for the trait MSPL with thirty rounds of five-fold cross-validation ###

con <- file("MSPL.log") 
sink(con, append=TRUE)
sink(con, append=TRUE, type="message")

data1<-read.csv("OTU0.7.csv")
data2<-read.csv("MSPLSNP.csv")
df.MSPL<-cbind(data1[,c(1,1011,2:1005,1015:1024)],data2[,-1])
data.MSPL<-data.frame(na.omit(df.MSPL))

options(scipen=200)
result<-c()
for (i in 3:1006){
        fit<-lm(MSPL~data.MSPL[,i],data=data.MSPL)
        result<-rbind(result,c(colnames(data.MSPL)[i],coef(summary(fit))[2,c(1,2,4)]))
}
colnames(result)[4] <- 'P'
r<-data.frame(result)
X<-r[order(r[,4]),]
X1<-r[1:200,]
#write.csv(X1,file="MSPLOTU.csv")
for (j in X1[1]){paste(j,collapse = "+")}->cc

for (s in 1:30){

#split
set.seed(s)
sub1<-sample(1:nrow(data.MSPL),round(nrow(data.MSPL)*1/5))
data_traint1<-data.MSPL[-sub1,]

sub2<-sample(1:nrow(data_traint1),round(nrow(data_traint1)*1/4))
data_traint2<-data_traint1[-sub2,]

sub3<-sample(1:nrow(data_traint2),round(nrow(data_traint2)*1/3))
data_traint3<-data_traint2[-sub3,]

sub4<-sample(1:nrow(data_traint3),round(nrow(data_traint3)*1/2))
data_traint4<-data_traint3[-sub4,]

sub5<-sample(1:nrow(data_traint4),round(nrow(data_traint4)*1))

data_test1<-data.MSPL[sub1,]
data_test2<-data_traint1[sub2,]
data_test3<-data_traint2[sub3,]
data_test4<-data_traint3[-sub4,]
data_test5<-data_traint3[sub4,]
data_train1<-rbind(data_test2,data_test3,data_test4,data_test5)
data_train2<-rbind(data_test1,data_test3,data_test4,data_test5)
data_train3<-rbind(data_test1,data_test2,data_test4,data_test5)
data_train4<-rbind(data_test1,data_test2,data_test3,data_test5)
data_train5<-rbind(data_test1,data_test2,data_test3,data_test4)

#m1
print(paste("seed:",s,"model1"))
MSPLm1 <- lm(paste0("MSPL~", paste(grep("^snp", colnames(data_train1), value = T), collapse = "+")), data = data_train1)
print(summary(MSPLm1))
MSPLm <- step(MSPLm1, direction = "backward")
MSPLm2 <- update(MSPLm, paste(". ~ . +", cc))

tryCatch({
MSPLm <- step(MSPLm2, direction = "backward")
name.snp <- grep("snp", names(MSPLm$coefficients), value = T)
name.otu <- grep("OTU", names(MSPLm$coefficients), value = T)
MSPLm3 <- update(MSPLm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
MSPLm <- step(MSPLm3, direction = "backward")
print(summary(MSPLm))
MSPLm4<-update(MSPLm, paste(". ~ . +", paste(grep("^PC", colnames(data_train1), value = T), collapse = "+")))
MSPLm <- step(MSPLm4, direction = "backward")
print(summary(MSPLm))

sry<-summary(MSPLm)
seed<-paste("seed:",s,"model1")
MSPE<-mean((data_test1$MSPL - predict.lm(MSPLm, data_test1)) ^ 2)
z<-cor.test(data_test1$MSPL,predict.lm(MSPLm, data_test1),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(MSPLm)$fstatistic[1]
d1<-summary(MSPLm)$fstatistic[2]
d2<-summary(MSPLm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model1 fail"))
seed<-paste("seed:",s,"model1")
MSPE<-0
Rsquare<-0
PearsonP<-0
PearsonE<-0
Pvalue<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})

#m2
print(paste("seed:",s,"model2"))
MSPLm1 <- lm(paste0("MSPL~", paste(grep("^snp", colnames(data_train2), value = T), collapse = "+")), data = data_train2)
print(summary(MSPLm1))
MSPLm <- step(MSPLm1, direction = "backward")
MSPLm2 <- update(MSPLm, paste(". ~ . +", cc))

tryCatch({
MSPLm <- step(MSPLm2, direction = "backward")
name.snp <- grep("snp", names(MSPLm$coefficients), value = T)
name.otu <- grep("OTU", names(MSPLm$coefficients), value = T)
MSPLm3 <- update(MSPLm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
MSPLm <- step(MSPLm3, direction = "backward")
print(summary(MSPLm))
MSPLm4<-update(MSPLm, paste(". ~ . +", paste(grep("^PC", colnames(data_train2), value = T), collapse = "+")))
MSPLm <- step(MSPLm4, direction = "backward")
print(summary(MSPLm))

sry<-summary(MSPLm)
seed<-paste("seed:",s,"model2")
MSPE<-mean((data_test2$MSPL - predict.lm(MSPLm, data_test2)) ^ 2)
z<-cor.test(data_test2$MSPL,predict.lm(MSPLm, data_test2),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(MSPLm)$fstatistic[1]
d1<-summary(MSPLm)$fstatistic[2]
d2<-summary(MSPLm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model2 fail"))
seed<-paste("seed:",s,"model2")
MSPE<-0
Rsquare<-0
Pvalue<-0
PearsonP<-0
PearsonE<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})

#m3
print(paste("seed:",s,"model3"))
MSPLm1 <- lm(paste0("MSPL~", paste(grep("^snp", colnames(data_train3), value = T), collapse = "+")), data = data_train3)
print(summary(MSPLm1))
MSPLm <- step(MSPLm1, direction = "backward")
MSPLm2 <- update(MSPLm, paste(". ~ . +", cc))

tryCatch({
MSPLm <- step(MSPLm2, direction = "backward")
name.snp <- grep("snp", names(MSPLm$coefficients), value = T)
name.otu <- grep("OTU", names(MSPLm$coefficients), value = T)
MSPLm3 <- update(MSPLm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
MSPLm <- step(MSPLm3, direction = "backward")
print(summary(MSPLm))
MSPLm4<-update(MSPLm, paste(". ~ . +", paste(grep("^PC", colnames(data_train3), value = T), collapse = "+")))
MSPLm <- step(MSPLm4, direction = "backward")
print(summary(MSPLm))

sry<-summary(MSPLm)
seed<-paste("seed:",s,"model3")
MSPE<-mean((data_test3$MSPL - predict.lm(MSPLm, data_test3)) ^ 2)
z<-cor.test(data_test3$MSPL,predict.lm(MSPLm, data_test3),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(MSPLm)$fstatistic[1]
d1<-summary(MSPLm)$fstatistic[2]
d2<-summary(MSPLm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model3 fail"))
seed<-paste("seed:",s,"model3")
MSPE<-0
Rsquare<-0
Pvalue<-0
PearsonP<-0
PearsonE<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})

#m4
print(paste("seed:",s,"model4"))
MSPLm1 <- lm(paste0("MSPL~", paste(grep("^snp", colnames(data_train4), value = T), collapse = "+")), data = data_train4)
print(summary(MSPLm1))
MSPLm <- step(MSPLm1, direction = "backward")
MSPLm2 <- update(MSPLm, paste(". ~ . +", cc))

tryCatch({
MSPLm <- step(MSPLm2, direction = "backward")
name.snp <- grep("snp", names(MSPLm$coefficients), value = T)
name.otu <- grep("OTU", names(MSPLm$coefficients), value = T)
MSPLm3 <- update(MSPLm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
MSPLm <- step(MSPLm3, direction = "backward")
print(summary(MSPLm))
MSPLm4<-update(MSPLm, paste(". ~ . +", paste(grep("^PC", colnames(data_train4), value = T), collapse = "+")))
MSPLm <- step(MSPLm4, direction = "backward")
print(summary(MSPLm))

sry<-summary(MSPLm)
seed<-paste("seed:",s,"model4")
MSPE<-mean((data_test4$MSPL - predict.lm(MSPLm, data_test4)) ^ 2)
z<-cor.test(data_test4$MSPL,predict.lm(MSPLm, data_test4),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(MSPLm)$fstatistic[1]
d1<-summary(MSPLm)$fstatistic[2]
d2<-summary(MSPLm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model4 fail"))
seed<-paste("seed:",s,"model4")
MSPE<-0
Rsquare<-0
Pvalue<-0
PearsonP<-0
PearsonE<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})

#m5
print(paste("seed:",s,"model5"))
MSPLm1 <- lm(paste0("MSPL~", paste(grep("^snp", colnames(data_train5), value = T), collapse = "+")), data = data_train5)
print(summary(MSPLm1))
MSPLm <- step(MSPLm1, direction = "backward")
MSPLm2 <- update(MSPLm, paste(". ~ . +", cc))

tryCatch({
MSPLm <- step(MSPLm2, direction = "backward")
name.snp <- grep("snp", names(MSPLm$coefficients), value = T)
name.otu <- grep("OTU", names(MSPLm$coefficients), value = T)
MSPLm3 <- update(MSPLm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
MSPLm <- step(MSPLm3, direction = "backward")
print(summary(MSPLm))
MSPLm4<-update(MSPLm, paste(". ~ . +", paste(grep("^PC", colnames(data_train5), value = T), collapse = "+")))
MSPLm <- step(MSPLm4, direction = "backward")
print(summary(MSPLm))

sry<-summary(MSPLm)
seed<-paste("seed:",s,"model5")
MSPE<-mean((data_test5$MSPL - predict.lm(MSPLm, data_test5)) ^ 2)
z<-cor.test(data_test5$MSPL,predict.lm(MSPLm, data_test5),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(MSPLm)$fstatistic[1]
d1<-summary(MSPLm)$fstatistic[2]
d2<-summary(MSPLm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model5 fail"))
seed<-paste("seed:",s,"model5")
MSPE<-0
Rsquare<-0
Pvalue<-0
PearsonP<-0
PearsonE<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})
}

#### Linear mixed models for the trait MSPW with thirty rounds of five-fold cross-validation ###

con <- file("MSPW.log") 
sink(con, append=TRUE)
sink(con, append=TRUE, type="message")

data1<-read.csv("OTU0.7.csv")
data2<-read.csv("MSPWSNP.csv")
df.MSPW<-cbind(data1[,c(1,1012,2:1005,1015:1024)],data2[,-1])
data.MSPW<-data.frame(na.omit(df.MSPW))

options(scipen=200)
result<-c()
for (i in 3:1006){
        fit<-lm(MSPW~data.MSPW[,i],data=data.MSPW)
        result<-rbind(result,c(colnames(data.MSPW)[i],coef(summary(fit))[2,c(1,2,4)]))
}
colnames(result)[4] <- 'P'
r<-data.frame(result)
X<-r[order(r[,4]),]
X1<-r[1:200,]
#write.csv(X1,file="MSPWOTU.csv")
for (j in X1[1]){paste(j,collapse = "+")}->cc

for (s in 1:30){

#split
set.seed(s)
sub1<-sample(1:nrow(data.MSPW),round(nrow(data.MSPW)*1/5))
data_traint1<-data.MSPW[-sub1,]

sub2<-sample(1:nrow(data_traint1),round(nrow(data_traint1)*1/4))
data_traint2<-data_traint1[-sub2,]

sub3<-sample(1:nrow(data_traint2),round(nrow(data_traint2)*1/3))
data_traint3<-data_traint2[-sub3,]

sub4<-sample(1:nrow(data_traint3),round(nrow(data_traint3)*1/2))
data_traint4<-data_traint3[-sub4,]

sub5<-sample(1:nrow(data_traint4),round(nrow(data_traint4)*1))

data_test1<-data.MSPW[sub1,]
data_test2<-data_traint1[sub2,]
data_test3<-data_traint2[sub3,]
data_test4<-data_traint3[-sub4,]
data_test5<-data_traint3[sub4,]
data_train1<-rbind(data_test2,data_test3,data_test4,data_test5)
data_train2<-rbind(data_test1,data_test3,data_test4,data_test5)
data_train3<-rbind(data_test1,data_test2,data_test4,data_test5)
data_train4<-rbind(data_test1,data_test2,data_test3,data_test5)
data_train5<-rbind(data_test1,data_test2,data_test3,data_test4)

#m1
print(paste("seed:",s,"model1"))
MSPWm1 <- lm(paste0("MSPW~", paste(grep("^snp", colnames(data_train1), value = T), collapse = "+")), data = data_train1)
print(summary(MSPWm1))
MSPWm <- step(MSPWm1, direction = "backward")
MSPWm2 <- update(MSPWm, paste(". ~ . +", cc))

tryCatch({
MSPWm <- step(MSPWm2, direction = "backward")
name.snp <- grep("snp", names(MSPWm$coefficients), value = T)
name.otu <- grep("OTU", names(MSPWm$coefficients), value = T)
MSPWm3 <- update(MSPWm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
MSPWm <- step(MSPWm3, direction = "backward")
print(summary(MSPWm))
MSPWm4<-update(MSPWm, paste(". ~ . +", paste(grep("^PC", colnames(data_train1), value = T), collapse = "+")))
MSPWm <- step(MSPWm4, direction = "backward")
print(summary(MSPWm))

sry<-summary(MSPWm)
seed<-paste("seed:",s,"model1")
MSPE<-mean((data_test1$MSPW - predict.lm(MSPWm, data_test1)) ^ 2)
z<-cor.test(data_test1$MSPW,predict.lm(MSPWm, data_test1),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(MSPWm)$fstatistic[1]
d1<-summary(MSPWm)$fstatistic[2]
d2<-summary(MSPWm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model1 fail"))
seed<-paste("seed:",s,"model1")
MSPE<-0
Rsquare<-0
PearsonP<-0
PearsonE<-0
Pvalue<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})

#m2
print(paste("seed:",s,"model2"))
MSPWm1 <- lm(paste0("MSPW~", paste(grep("^snp", colnames(data_train2), value = T), collapse = "+")), data = data_train2)
print(summary(MSPWm1))
MSPWm <- step(MSPWm1, direction = "backward")
MSPWm2 <- update(MSPWm, paste(". ~ . +", cc))

tryCatch({
MSPWm <- step(MSPWm2, direction = "backward")
name.snp <- grep("snp", names(MSPWm$coefficients), value = T)
name.otu <- grep("OTU", names(MSPWm$coefficients), value = T)
MSPWm3 <- update(MSPWm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
MSPWm <- step(MSPWm3, direction = "backward")
print(summary(MSPWm))
MSPWm4<-update(MSPWm, paste(". ~ . +", paste(grep("^PC", colnames(data_train2), value = T), collapse = "+")))
MSPWm <- step(MSPWm4, direction = "backward")
print(summary(MSPWm))

sry<-summary(MSPWm)
seed<-paste("seed:",s,"model2")
MSPE<-mean((data_test2$MSPW - predict.lm(MSPWm, data_test2)) ^ 2)
z<-cor.test(data_test2$MSPW,predict.lm(MSPWm, data_test2),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(MSPWm)$fstatistic[1]
d1<-summary(MSPWm)$fstatistic[2]
d2<-summary(MSPWm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model2 fail"))
seed<-paste("seed:",s,"model2")
MSPE<-0
Rsquare<-0
Pvalue<-0
PearsonP<-0
PearsonE<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})

#m3
print(paste("seed:",s,"model3"))
MSPWm1 <- lm(paste0("MSPW~", paste(grep("^snp", colnames(data_train3), value = T), collapse = "+")), data = data_train3)
print(summary(MSPWm1))
MSPWm <- step(MSPWm1, direction = "backward")
MSPWm2 <- update(MSPWm, paste(". ~ . +", cc))

tryCatch({
MSPWm <- step(MSPWm2, direction = "backward")
name.snp <- grep("snp", names(MSPWm$coefficients), value = T)
name.otu <- grep("OTU", names(MSPWm$coefficients), value = T)
MSPWm3 <- update(MSPWm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
MSPWm <- step(MSPWm3, direction = "backward")
print(summary(MSPWm))
MSPWm4<-update(MSPWm, paste(". ~ . +", paste(grep("^PC", colnames(data_train3), value = T), collapse = "+")))
MSPWm <- step(MSPWm4, direction = "backward")
print(summary(MSPWm))

sry<-summary(MSPWm)
seed<-paste("seed:",s,"model3")
MSPE<-mean((data_test3$MSPW - predict.lm(MSPWm, data_test3)) ^ 2)
z<-cor.test(data_test3$MSPW,predict.lm(MSPWm, data_test3),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(MSPWm)$fstatistic[1]
d1<-summary(MSPWm)$fstatistic[2]
d2<-summary(MSPWm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model3 fail"))
seed<-paste("seed:",s,"model3")
MSPE<-0
Rsquare<-0
Pvalue<-0
PearsonP<-0
PearsonE<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})

#m4
print(paste("seed:",s,"model4"))
MSPWm1 <- lm(paste0("MSPW~", paste(grep("^snp", colnames(data_train4), value = T), collapse = "+")), data = data_train4)
print(summary(MSPWm1))
MSPWm <- step(MSPWm1, direction = "backward")
MSPWm2 <- update(MSPWm, paste(". ~ . +", cc))

tryCatch({
MSPWm <- step(MSPWm2, direction = "backward")
name.snp <- grep("snp", names(MSPWm$coefficients), value = T)
name.otu <- grep("OTU", names(MSPWm$coefficients), value = T)
MSPWm3 <- update(MSPWm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
MSPWm <- step(MSPWm3, direction = "backward")
print(summary(MSPWm))
MSPWm4<-update(MSPWm, paste(". ~ . +", paste(grep("^PC", colnames(data_train4), value = T), collapse = "+")))
MSPWm <- step(MSPWm4, direction = "backward")
print(summary(MSPWm))

sry<-summary(MSPWm)
seed<-paste("seed:",s,"model4")
MSPE<-mean((data_test4$MSPW - predict.lm(MSPWm, data_test4)) ^ 2)
z<-cor.test(data_test4$MSPW,predict.lm(MSPWm, data_test4),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(MSPWm)$fstatistic[1]
d1<-summary(MSPWm)$fstatistic[2]
d2<-summary(MSPWm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model4 fail"))
seed<-paste("seed:",s,"model4")
MSPE<-0
Rsquare<-0
Pvalue<-0
PearsonP<-0
PearsonE<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})

#m5
print(paste("seed:",s,"model5"))
MSPWm1 <- lm(paste0("MSPW~", paste(grep("^snp", colnames(data_train5), value = T), collapse = "+")), data = data_train5)
print(summary(MSPWm1))
MSPWm <- step(MSPWm1, direction = "backward")
MSPWm2 <- update(MSPWm, paste(". ~ . +", cc))

tryCatch({
MSPWm <- step(MSPWm2, direction = "backward")
name.snp <- grep("snp", names(MSPWm$coefficients), value = T)
name.otu <- grep("OTU", names(MSPWm$coefficients), value = T)
MSPWm3 <- update(MSPWm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
MSPWm <- step(MSPWm3, direction = "backward")
print(summary(MSPWm))
MSPWm4<-update(MSPWm, paste(". ~ . +", paste(grep("^PC", colnames(data_train5), value = T), collapse = "+")))
MSPWm <- step(MSPWm4, direction = "backward")
print(summary(MSPWm))

sry<-summary(MSPWm)
seed<-paste("seed:",s,"model5")
MSPE<-mean((data_test5$MSPW - predict.lm(MSPWm, data_test5)) ^ 2)
z<-cor.test(data_test5$MSPW,predict.lm(MSPWm, data_test5),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(MSPWm)$fstatistic[1]
d1<-summary(MSPWm)$fstatistic[2]
d2<-summary(MSPWm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model5 fail"))
seed<-paste("seed:",s,"model5")
MSPE<-0
Rsquare<-0
Pvalue<-0
PearsonP<-0
PearsonE<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})
}

#### Linear mixed models for the trait PGW with thirty rounds of five-fold cross-validation ####
con <- file("PGW.log") 
sink(con, append=TRUE)
sink(con, append=TRUE, type="message")

data1<-read.csv("OTU0.7.csv")
data2<-read.csv("PGWSNP.csv")
df.PGW<-cbind(data1[,c(1,1013,2:1005,1015:1024)],data2[,-1])
data.PGW<-data.frame(na.omit(df.PGW))

options(scipen=200)
result<-c()
for (i in 3:1006){
        fit<-lm(PGW~data.PGW[,i],data=data.PGW)
        result<-rbind(result,c(colnames(data.PGW)[i],coef(summary(fit))[2,c(1,2,4)]))
}
colnames(result)[4] <- 'P'
r<-data.frame(result)
X<-r[order(r[,4]),]
X1<-r[1:200,]
#write.csv(X1,file="PGWOTU.csv")
for (j in X1[1]){paste(j,collapse = "+")}->cc

for (s in 1:30){

#split
set.seed(s)
sub1<-sample(1:nrow(data.PGW),round(nrow(data.PGW)*1/5))
data_traint1<-data.PGW[-sub1,]

sub2<-sample(1:nrow(data_traint1),round(nrow(data_traint1)*1/4))
data_traint2<-data_traint1[-sub2,]

sub3<-sample(1:nrow(data_traint2),round(nrow(data_traint2)*1/3))
data_traint3<-data_traint2[-sub3,]

sub4<-sample(1:nrow(data_traint3),round(nrow(data_traint3)*1/2))
data_traint4<-data_traint3[-sub4,]

sub5<-sample(1:nrow(data_traint4),round(nrow(data_traint4)*1))

data_test1<-data.PGW[sub1,]
data_test2<-data_traint1[sub2,]
data_test3<-data_traint2[sub3,]
data_test4<-data_traint3[-sub4,]
data_test5<-data_traint3[sub4,]
data_train1<-rbind(data_test2,data_test3,data_test4,data_test5)
data_train2<-rbind(data_test1,data_test3,data_test4,data_test5)
data_train3<-rbind(data_test1,data_test2,data_test4,data_test5)
data_train4<-rbind(data_test1,data_test2,data_test3,data_test5)
data_train5<-rbind(data_test1,data_test2,data_test3,data_test4)

#m1
print(paste("seed:",s,"model1"))
PGWm1 <- lm(paste0("PGW~", paste(grep("^snp", colnames(data_train1), value = T), collapse = "+")), data = data_train1)
print(summary(PGWm1))
PGWm <- step(PGWm1, direction = "backward")
PGWm2 <- update(PGWm, paste(". ~ . +", cc))

tryCatch({
PGWm <- step(PGWm2, direction = "backward")
name.snp <- grep("snp", names(PGWm$coefficients), value = T)
name.otu <- grep("OTU", names(PGWm$coefficients), value = T)
PGWm3 <- update(PGWm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
PGWm <- step(PGWm3, direction = "backward")
print(summary(PGWm))
PGWm4<-update(PGWm, paste(". ~ . +", paste(grep("^PC", colnames(data_train1), value = T), collapse = "+")))
PGWm <- step(PGWm4, direction = "backward")
print(summary(PGWm))

sry<-summary(PGWm)
seed<-paste("seed:",s,"model1")
MSPE<-mean((data_test1$PGW - predict.lm(PGWm, data_test1)) ^ 2)
z<-cor.test(data_test1$PGW,predict.lm(PGWm, data_test1),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(PGWm)$fstatistic[1]
d1<-summary(PGWm)$fstatistic[2]
d2<-summary(PGWm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model1 fail"))
seed<-paste("seed:",s,"model1")
MSPE<-0
Rsquare<-0
PearsonP<-0
PearsonE<-0
Pvalue<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})

#m2
print(paste("seed:",s,"model2"))
PGWm1 <- lm(paste0("PGW~", paste(grep("^snp", colnames(data_train2), value = T), collapse = "+")), data = data_train2)
print(summary(PGWm1))
PGWm <- step(PGWm1, direction = "backward")
PGWm2 <- update(PGWm, paste(". ~ . +", cc))

tryCatch({
PGWm <- step(PGWm2, direction = "backward")
name.snp <- grep("snp", names(PGWm$coefficients), value = T)
name.otu <- grep("OTU", names(PGWm$coefficients), value = T)
PGWm3 <- update(PGWm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
PGWm <- step(PGWm3, direction = "backward")
print(summary(PGWm))
PGWm4<-update(PGWm, paste(". ~ . +", paste(grep("^PC", colnames(data_train2), value = T), collapse = "+")))
PGWm <- step(PGWm4, direction = "backward")
print(summary(PGWm))

sry<-summary(PGWm)
seed<-paste("seed:",s,"model2")
MSPE<-mean((data_test2$PGW - predict.lm(PGWm, data_test2)) ^ 2)
z<-cor.test(data_test2$PGW,predict.lm(PGWm, data_test2),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(PGWm)$fstatistic[1]
d1<-summary(PGWm)$fstatistic[2]
d2<-summary(PGWm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model2 fail"))
seed<-paste("seed:",s,"model2")
MSPE<-0
Rsquare<-0
Pvalue<-0
PearsonP<-0
PearsonE<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})

#m3
print(paste("seed:",s,"model3"))
PGWm1 <- lm(paste0("PGW~", paste(grep("^snp", colnames(data_train3), value = T), collapse = "+")), data = data_train3)
print(summary(PGWm1))
PGWm <- step(PGWm1, direction = "backward")
PGWm2 <- update(PGWm, paste(". ~ . +", cc))

tryCatch({
PGWm <- step(PGWm2, direction = "backward")
name.snp <- grep("snp", names(PGWm$coefficients), value = T)
name.otu <- grep("OTU", names(PGWm$coefficients), value = T)
PGWm3 <- update(PGWm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
PGWm <- step(PGWm3, direction = "backward")
print(summary(PGWm))
PGWm4<-update(PGWm, paste(". ~ . +", paste(grep("^PC", colnames(data_train3), value = T), collapse = "+")))
PGWm <- step(PGWm4, direction = "backward")
print(summary(PGWm))

sry<-summary(PGWm)
seed<-paste("seed:",s,"model3")
MSPE<-mean((data_test3$PGW - predict.lm(PGWm, data_test3)) ^ 2)
z<-cor.test(data_test3$PGW,predict.lm(PGWm, data_test3),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(PGWm)$fstatistic[1]
d1<-summary(PGWm)$fstatistic[2]
d2<-summary(PGWm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model3 fail"))
seed<-paste("seed:",s,"model3")
MSPE<-0
Rsquare<-0
Pvalue<-0
PearsonP<-0
PearsonE<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})

#m4
print(paste("seed:",s,"model4"))
PGWm1 <- lm(paste0("PGW~", paste(grep("^snp", colnames(data_train4), value = T), collapse = "+")), data = data_train4)
print(summary(PGWm1))
PGWm <- step(PGWm1, direction = "backward")
PGWm2 <- update(PGWm, paste(". ~ . +", cc))

tryCatch({
PGWm <- step(PGWm2, direction = "backward")
name.snp <- grep("snp", names(PGWm$coefficients), value = T)
name.otu <- grep("OTU", names(PGWm$coefficients), value = T)
PGWm3 <- update(PGWm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
PGWm <- step(PGWm3, direction = "backward")
print(summary(PGWm))
PGWm4<-update(PGWm, paste(". ~ . +", paste(grep("^PC", colnames(data_train4), value = T), collapse = "+")))
PGWm <- step(PGWm4, direction = "backward")
print(summary(PGWm))

sry<-summary(PGWm)
seed<-paste("seed:",s,"model4")
MSPE<-mean((data_test4$PGW - predict.lm(PGWm, data_test4)) ^ 2)
z<-cor.test(data_test4$PGW,predict.lm(PGWm, data_test4),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(PGWm)$fstatistic[1]
d1<-summary(PGWm)$fstatistic[2]
d2<-summary(PGWm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model4 fail"))
seed<-paste("seed:",s,"model4")
MSPE<-0
Rsquare<-0
Pvalue<-0
PearsonP<-0
PearsonE<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})

#m5
print(paste("seed:",s,"model5"))
PGWm1 <- lm(paste0("PGW~", paste(grep("^snp", colnames(data_train5), value = T), collapse = "+")), data = data_train5)
print(summary(PGWm1))
PGWm <- step(PGWm1, direction = "backward")
PGWm2 <- update(PGWm, paste(". ~ . +", cc))

tryCatch({
PGWm <- step(PGWm2, direction = "backward")
name.snp <- grep("snp", names(PGWm$coefficients), value = T)
name.otu <- grep("OTU", names(PGWm$coefficients), value = T)
PGWm3 <- update(PGWm, paste(". ~ . +", paste(paste(rep(name.snp, length(name.otu)), name.otu, sep = "*"), collapse = "+")))
PGWm <- step(PGWm3, direction = "backward")
print(summary(PGWm))
PGWm4<-update(PGWm, paste(". ~ . +", paste(grep("^PC", colnames(data_train5), value = T), collapse = "+")))
PGWm <- step(PGWm4, direction = "backward")
print(summary(PGWm))

sry<-summary(PGWm)
seed<-paste("seed:",s,"model5")
MSPE<-mean((data_test5$PGW - predict.lm(PGWm, data_test5)) ^ 2)
z<-cor.test(data_test5$PGW,predict.lm(PGWm, data_test5),method = "pearson")
PearsonP<-z$p.value
PearsonE<-z$estimate
Rsquare<-sry$adj.r.squared
f<-summary(PGWm)$fstatistic[1]
d1<-summary(PGWm)$fstatistic[2]
d2<-summary(PGWm)$fstatistic[3]
Pvalue<-pf(f,d1,d2,lower.tail=F)
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)

},error = function(e){
print(paste("seed:",s,"model5 fail"))
seed<-paste("seed:",s,"model5")
MSPE<-0
Rsquare<-0
Pvalue<-0
PearsonP<-0
PearsonE<-0
write.table(data.frame(seed,Rsquare,Pvalue,MSPE,PearsonE,PearsonP),file="summary",row.names =FALSE, col.names =FALSE, quote=FALSE,append=TRUE)
})
}


###Figure 2A-F showed the Rsquare of observed values and predicted values from the best regression model###
library(ggplot2)
MSPD=read.csv("MSPD_pred.csv", header=T)
MSW=read.csv("MSW_pred.csv", header=T)
TSLW=read.csv("TSLW_pred.csv", header=T)
MSPW=read.csv("MSPW_pred.csv", header=T)
PGW=read.csv("PGW_pred.csv", header=T)
MSPL=read.csv("MSPL_pred.csv", header=T)
windows(6,4)
####Figure2A####
ggplot(TSLW, aes(x=TSLW, y=pred))+geom_point(shape=21,size=3,colour="black", fill="#339999")+stat_smooth(method=lm,level = 0.95, colour="darkgrey")+theme(panel.background = element_blank(),axis.line = element_line(colour = "black"),axis.text.x=element_text(colour="black",size=12),axis.text.y=element_text(size=12,face="plain"), panel.border = element_rect(fill = NA))

####Figure2B####
ggplot(MSW, aes(x=MSW, y=pred))+geom_point(shape=21,size=3,colour="black", fill="#339999")+stat_smooth(method=lm,level = 0.95, colour="darkgrey")+theme(panel.background = element_blank(),axis.line = element_line(colour = "black"),axis.text.x=element_text(colour="black",size=12),axis.text.y=element_text(size=12,face="plain"), panel.border = element_rect(fill = NA))

####Figure2C####
ggplot(MSPD, aes(x=MSPD, y=pred))+geom_point(shape=21,size=3,colour="black", fill="#339999")+stat_smooth(method=lm,level = 0.95, colour="darkgrey")+theme(panel.background = element_blank(),axis.line = element_line(colour = "black"),axis.text.x=element_text(colour="black",size=12),axis.text.y=element_text(size=12,face="plain"), panel.border = element_rect(fill = NA))
####Figure2D####
ggplot(MSPW, aes(x=MSPW, y=pred))+geom_point(shape=21,size=3,colour="black", fill="orange")+stat_smooth(method=lm,level = 0.95, colour="darkgrey")+theme(panel.background = element_blank(),axis.line = element_line(colour = "black"),axis.text.x=element_text(colour="black",size=12),axis.text.y=element_text(size=12,face="plain"), panel.border = element_rect(fill = NA))

####Figure2E####
ggplot(PGW, aes(x=PGW, y=pred))+geom_point(shape=21,size=3,colour="black", fill="orange")+stat_smooth(method=lm,level = 0.95, colour="darkgrey")+theme(panel.background = element_blank(),axis.line = element_line(colour = "black"),axis.text.x=element_text(colour="black",size=12),axis.text.y=element_text(size=12,face="plain"), panel.border = element_rect(fill = NA))

####Figure2F####
ggplot(MSPL, aes(x=MSPL, y=pred))+geom_point(shape=21,size=3,colour="black", fill="orange")+stat_smooth(method=lm,level = 0.95, colour="darkgrey")+theme(panel.background = element_blank(),axis.line = element_line(colour = "black"),axis.text.x=element_text(colour="black",size=12),axis.text.y=element_text(size=12,face="plain"), panel.border = element_rect(fill = NA))


```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
